# ロックと同期

ロックとは、プロジェクトの依存関係を [ロックファイル](./layout.md#the-lockfile) に解決するプロセスです。同期とは、ロックファイルからパッケージのサブセットを [プロジェクト環境](./layout.md#the-project-environment) にインストールするプロセスです。

## 自動ロックと同期 {#automatic-lock-and-sync}

ロックと同期は uv では _自動_ です。たとえば、`uv run` を使用すると、要求されたコマンドを呼び出す前にプロジェクトがロックされ、同期されます。これにより、プロジェクト環境が常に最新の状態になります。同様に、`uv tree` などのロックファイルを読み取るコマンドは、実行前に自動的に更新します。

自動ロックを無効にするには、`--locked` オプションを使用します:

```console
$ uv run --locked ...
```

ロックファイルが最新でない場合、 uv はロックファイルを更新する代わりにエラーを発生させます。

ロックファイルが最新かどうかを確認せずに使用するには、`--frozen` オプションを使用します:

```console
$ uv run --frozen ...
```

同様に、環境が最新かどうかを確認せずにコマンドを実行するには、`--no-sync` オプションを使用します:

```console
$ uv run --no-sync ...
```

## ロックファイルが最新かどうかの確認

ロックファイルが最新かどうかを検討する際、uv はそれがプロジェクト メタデータと一致するかどうかを確認します。たとえば、`pyproject.toml` に依存関係を追加すると、ロックファイルは古いものと見なされます。同様に、依存関係のバージョン制約を変更してロックされたバージョンを除外すると、ロックファイルは古いものと見なされます。ただし、既存のロックされたバージョンがまだ含まれるようにバージョン制約を変更すると、ロックファイルは最新であると見なされます。

`--check` フラグを `uv lock` に渡すことで、ロックファイルが最新かどうかを確認できます:

```console
$ uv lock --check
```

これは他のコマンドの `--locked` フラグと同等です。

!!! important

    uv は、パッケージの新しいバージョンがリリースされてもロックファイルが古いとは見なしません。依存関係をアップグレードする場合は、ロックファイルを明示的に更新する必要があります。詳細については、[ロックされたパッケージのバージョンのアップグレード](#upgrading-locked-package-versions)に関するドキュメントを参照してください。

## ロックファイルの作成

ロックファイルは [自動的に](#automatic-lock-and-sync) 作成されますが、`uv lock` を使用してロックファイルを明示的に作成または更新することもできます:

```console
$ uv lock
```

## 環境の同期

環境は [自動的に](#automatic-lock-and-sync) 同期されますが、`uv sync` を使用して明示的に同期することもできます:

```console
$ uv sync
```

環境を手動で同期することは、エディターに正しいバージョンの依存関係があることを確認するのに特に役立ちます。

### 編集可能なインストール

環境が同期されると、uv はプロジェクト (および他のワークスペース メンバー) を _編集可能な_ パッケージとしてインストールするため、変更を環境に反映するために再同期する必要はありません。

この動作をオプトアウトするには、`--no-editable` オプションを使用します。

!!! note

    プロジェクトでビルド システムが定義されていない場合はインストールされません。詳細については、[ビルド システム](./config.md#build-systems) のドキュメントを参照してください。

### 不要なパッケージの保持

同期はデフォルトでは「正確」に行われます。つまり、ロックファイルに存在しないパッケージはすべて削除されます。

不要なパッケージを保持するには、`--inexact` オプションを使用します:

```console
$ uv sync --inexact
```

### オプションの依存関係の同期

uv は `[project.optional-dependencies]` テーブルからオプションの依存関係を読み取ります。これらは、多くの場合「extras」と呼ばれます。

uv はデフォルトでは追加情報を同期しません。追加情報を含めるには `--extra` オプションを使用します。

```console
$ uv sync --extra foo
```

すべての追加機能をすばやく有効にするには、`--all-extras` オプションを使用します。

オプションの依存関係を管理する方法の詳細については、[オプションの依存関係](./dependencies.md#optional-dependencies)のドキュメントを参照してください。

### 開発依存関係の同期

uv は、開発依存関係を `[dependency-groups]` テーブルから読み取ります ([PEP 735](https://peps.python.org/pep-0735/) で定義されています)。

`dev` グループは特別なケースであり、デフォルトで同期されます。デフォルトの変更の詳細については、[デフォルト グループ](./dependencies.md#default-groups) のドキュメントを参照してください。

`--no-dev` フラグを使用すると、`dev` グループを除外できます。

`--only-dev` フラグを使用すると、プロジェクトとその依存関係なしで `dev` グループをインストールできます。

`--all-groups`、`--no-default-groups`、`--group <name>`、`--only-group <name>`、および `--no-group <name>` オプションを使用して、追加のグループを含めたり除外したりできます。`--only-group` のセマンティクスは `--only-dev` と同じで、プロジェクトは含まれません。ただし、`--only-group` はデフォルト グループも除外します。

グループの除外は常に包含よりも優先されるため、次のコマンドを実行します:

```
$ uv sync --no-group foo --group foo
```

`foo` グループはインストールされません。

開発依存関係を管理する方法の詳細については、[開発依存関係](./dependencies.md#development-dependencies)のドキュメントを参照してください。

## ロックされたパッケージバージョンのアップグレード {#upgrading-locked-package-versions}

`uv.lock` ファイルが存在する場合、uv は `uv sync` および `uv lock` を実行するときに、以前にロックされたバージョンのパッケージを優先します。パッケージのバージョンは、プロジェクトの依存関係の制約によって以前のロックされたバージョンが除外される場合にのみ変更されます。

すべてのパッケージをアップグレードするには:

```console
$ uv lock --upgrade
```

他のすべてのパッケージのロックされたバージョンを保持しながら、単一のパッケージを最新バージョンにアップグレードするには:

```console
$ uv lock --upgrade-package <package>
```

単一のパッケージを特定のバージョンにアップグレードするには:

```console
$ uv lock --upgrade-package <package>==<version>
```

いずれの場合も、アップグレードはプロジェクトの依存関係の制約に制限されます。たとえば、プロジェクトでパッケージの上限が定義されている場合、アップグレードはそのバージョンを超えることはできません。

!!! note

    uv は Git 依存関係に同様のロジックを適用します。たとえば、Git 依存関係が `main` ブランチを参照する場合、`--upgrade` または `--upgrade-package` フラグが使用されていない限り、uv は `main` ブランチの最新のコミットよりも、既存の `uv.lock` ファイル内のロックされたコミット SHA を優先します。

これらのフラグは、ロックファイルと環境を更新するために `uv sync` または `uv run` に提供することもできます。

## ロックファイルのエクスポート

uv を他のツールやワークフローと統合する必要がある場合は、`uv export --format requirements-txt` を使用して `uv.lock` を `requirements.txt` 形式にエクスポートできます。生成された `requirements.txt` ファイルは、`uv pip install` または `pip` などの他のツールを使用してインストールできます。

一般的に、`uv.lock` ファイルと `requirements.txt` ファイルの両方を使用することはお勧めしません。`uv.lock` ファイルをエクスポートする場合は、問題を報告して使用事例について話し合うことを検討してください。

## 部分的なインストール

場合によっては、Docker イメージの構築中にレイヤー キャッシュを最適化するなど、複数のステップでインストールを実行すると便利なことがあります。`uv sync` には、この目的のためのフラグがいくつかあります。

- `--no-install-project`: 現在のプロジェクトをインストールしない
- `--no-install-workspace`: ルートプロジェクトを含むワークスペースメンバーをインストールしないでください
- `--no-install-package <NO_INSTALL_PACKAGE>`: 指定されたパッケージをインストールしない

これらのオプションを使用すると、ターゲットのすべての依存関係は引き続きインストールされます。たとえば、`--no-install-project` は _プロジェクト_ を省略しますが、その依存関係は省略しません。

これらのフラグを不適切に使用すると、パッケージの依存関係が失われることがあるため、環境が壊れる可能性があります。
